# Test Clients for kusto-dashboard-manager MCP Server

This directory contains various test clients to validate the MCP server functionality.

## Working Clients (USE THESE)

### JavaScript Clients (RECOMMENDED)
- **`test-js-kusto.js`** - Tests kusto-dashboard-manager MCP server
  - ✅ Works with Content-Length framing
  - ✅ Uses official MCP SDK (@modelcontextprotocol/sdk)
  - Tests: connection, tool discovery, dashboard parsing
  - Usage: `node test-js-kusto.js` or `npm run test:kusto`
  - Debug: `node test-js-kusto.js --debug` or `npm run test:kusto:debug`

- **`test-js-playwright.js`** - Tests Playwright MCP server
  - ✅ Validates that MCP SDK client works with @playwright/mcp
  - Tests: connection, tool discovery, navigation, snapshot, screenshot, click
  - Usage: `node test-js-playwright.js` or `npm run test:playwright`
  - Debug: `node test-js-playwright.js --debug` or `npm run test:playwright:debug`

### Python Clients
- **`test_mcp_client.py`** - Simple Python client for kusto-dashboard-manager
  - ✅ Works with newline-delimited JSON
  - Direct JSON-RPC implementation
  - Tests: connection, tool listing, dashboard parsing
  - Usage: `python client/test_mcp_client.py`

## Experimental/SDK Clients (FOR REFERENCE)

These clients use the Python MCP SDK and Content-Length framing:

- **`test_kusto_client.py`** - SDK-based Python client for kusto-dashboard-manager
  - Uses Content-Length framing
  - Based on working-py-mcp-client.py pattern
  - Status: Works but hangs on protocol negotiation with some configs

- **`test_playwright_client.py`** - SDK-based Python client for Playwright MCP
  - Attempts to test Content-Length framing
  - Status: Platform/command issues on Windows

## SDK Reference Files (DO NOT MODIFY)

- **`python-mcp-client-sdk-20251010-092718/`** - Python MCP SDK snapshot
- **`python-mcp-client-sdk-20251010-092718.zip`** - Backup archive
- **`basic-py-mcp-client.py`** - SDK example (from SDK package)
- **`py-mcp-client.py`** - SDK example (from SDK package)
- **`simple-py-mcp-client.py`** - SDK example (from SDK package)
- **`working-py-mcp-client.py`** - SDK example (from SDK package)

## Dependencies

### JavaScript
```bash
npm install
# Installs @modelcontextprotocol/sdk
```

### Python
```bash
pip install -r requirements.txt
```

## MCP Protocol Notes

### Newline-Delimited JSON (VS Code Default)
- Each JSON-RPC message on its own line
- Used by: VS Code, test_mcp_client.py
- Format: `{"jsonrpc":"2.0","id":1,"method":"initialize","params":{...}}\n`

### Content-Length Framing (MCP SDK Default)
- HTTP-style headers with Content-Length
- Used by: MCP SDK clients (JavaScript, Python SDK)
- Format:
  ```
  Content-Length: 123\r\n\r\n
  {"jsonrpc":"2.0","id":1,"method":"initialize","params":{...}}
  ```

**The kusto-dashboard-manager server only supports newline-delimited JSON**, which is the standard for VS Code MCP servers. The MCP SDK handles this automatically when using `StdioClientTransport`.

## Playwright Snapshot YAML Format

The dashboard parser expects accessibility snapshot data in this specific format:

```yaml
- row "Dashboard Name time_description date creator_name" [ref=
  - /url: /dashboards/{guid}
  - rowheader "Dashboard Name"
```

### Example:
```yaml
- row "armprod about 1 hour ago 10/10/2025 Jason Gilbertson" [ref=
  - /url: /dashboards/12345678-1234-1234-1234-123456789abc
  - rowheader "armprod"
```

### Format Details:
1. **Row line**: `row "text" [ref=`
   - Contains: name, relative time, date (MM/DD/YYYY), creator name
   - Parser extracts creator by finding date pattern and taking everything after it

2. **URL line**: `/url: /dashboards/{guid}`
   - Must be within 10 lines after row line
   - GUID format: 8-4-4-4-12 hexadecimal

3. **Name line**: `rowheader "name"`
   - Clean dashboard name (preferred over row text)
   - Must be within 10 lines after row line

### Non-Standard YAML Warning
⚠️ This is NOT standard YAML! It's a custom format generated by Playwright's accessibility snapshot API. The parser uses regex pattern matching, not YAML parsing libraries.

## Test Results Summary

| Client | Protocol | Status | Notes |
|--------|----------|--------|-------|
| test-js-kusto.js | Content-Length | ✅ Working | Official SDK, comprehensive tests |
| test-js-playwright.js | Content-Length | ✅ Working | Validates MCP SDK functionality |
| test_mcp_client.py | Newline JSON | ✅ Working | Simple, direct implementation |
| test_kusto_client.py | Content-Length | ⚠️ Partial | Works but slow protocol negotiation |
| test_playwright_client.py | Content-Length | ❌ Platform issues | Windows npx command problems |

## Recommendations

1. **For development testing**: Use `test-js-kusto.js` (fastest, most reliable)
2. **For CI/CD**: Use `test_mcp_client.py` (no Node.js dependency)
3. **For VS Code integration**: Server works with built-in MCP client (newline JSON)
4. **For debugging**: Use `--debug` flag with JavaScript clients for verbose output

## Known Issues

1. **Logging format error** (FIXED): tracer.py had invalid date format string `%f`
2. **Dashboard parsing**: Requires exact Playwright snapshot format (documented above)
3. **Windows npx**: Requires `.cmd` extension or `shell=True` for subprocess calls

## Future Improvements

- [ ] Add support for standard YAML format
- [ ] Support Content-Length framing in Python server
- [ ] Add integration tests for full workflow (Playwright → Parse → Export)
- [ ] Add performance benchmarks
